<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: views/search-ui/search-ui.controller.js</title>
    
    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">
    
    <h1 class="page-title">Source: views/search-ui/search-ui.controller.js</h1>
    
    


    
    <section>
        <article>
            <pre class="prettyprint source"><code>/* @filename views/search-ui/search-ui.controller.js
 *
 * David Anderson 2012
 *
*/

define([
	'jquery','underscore','backbone','vent','reqres',
	'models/booking',
	'views/search-ui/search-ui.layout',
	'collections/multicom-accommodation',
	'collections/multicom-flight',
	'collections/symphony-hotel',
	'collections/symphony-airline',
	'models/symphony-hotel',
	'models/multicom/multicom-flight'
	
], function(	$,_,Backbone,vent,reqres,
				Booking,
				SearchUILayout,
				MulticomAccommodationCollection,
				MulticomFlightCollection,
				SymphonyHotelCollection,
				SymphonyAirlineCollection,
				SymphonyHotel,
				MulticomFlight
				){
	"use strict";
	
	
	var SearchUIController = Backbone.Marionette.Controller.extend(
	/** @lends SearchUIController# */
	{

		_isReady: true,
		_fetchRequestTotal: null,
		_fetchRequestComplete: null,
		_toCallWhenLoaded: null,
		
		_booking: null,
		
		_mcAccommCollection: null,
		_mcFlightCollection: null,
		_hotelCollection: null,

		_airlineCollection: null,
		
		
		/* Not really nice marionette code but we've bundled up a region in here due to the legacy router code */
		_layout: null,
		_region: null,
		
		
		/**
			Constructor
			
			options.testMode can be used to force the collections into test mode
			
			@class A Controller to co-ordinate all searching UI and activity
			
			@constructs
			@param {Object} [options] Options array
		*/
		initialize: function(options){
			options = options || {};
		
			_.bindAll(this);
			
			//init models
			this._booking = new Booking();
			
			//init collections
			this._mcAccommCollection = new MulticomAccommodationCollection();
			this._mcFlightCollection = new MulticomFlightCollection();
			this._hotelCollection = new SymphonyHotelCollection();
			this._airlineCollection = new SymphonyAirlineCollection();
			
			// TEST MODE
			if(options.testMode === true){
				this._airlineCollection.setTestMode(true);
			}
			
			//load needed 'init' data
			this.addLoadingRequest(this._airlineCollection.fetch({success: this.loadingCallback})); //get the data initially
			
			//bind to collections
			this.bindTo(this._mcFlightCollection,'complete',this.processFlightSearchResults,this);
			this.bindTo(this._mcAccommCollection,'complete',this.processHotelSearchResults,this);
			this.bindTo(this._hotelCollection,'complete',this.processHotelSearchResults,this);
			
			//initiator events
			this.bindTo(vent,'search:new',this.saveSearchData,this);
			this.bindTo(vent,'search:new:destination',this.saveSearchDestination,this);
			this.bindTo(vent,'search:trip:edit',this.saveSearchEdit,this);
			
			//feedback from selections
			this.bindTo(vent,'search:flight:selected',this.handleFlightSelection,this);
			this.bindTo(vent,'search:hotel:selected',this.handleHotelSelection,this);
			
			//shortlisting
			this.bindTo(vent,'search:shortlist',this.onShortlistRequest, this);
			
			
			//add response handlers for retrieving data in a decoupled maneer
			reqres.addHandler('search:get:booking', this.getBooking);
			reqres.addHandler('search:get:flight:results', this.getFlightCollection);
			reqres.addHandler('search:get:flight:selected', this.getFlightSelected);
			reqres.addHandler('search:get:hotel:results', this.getHotelCollection);
			reqres.addHandler('search:get:hotel:selected', this.getHotelSelected);
			reqres.addHandler('search:get:airlines', this.getAirlines);
			
			//init our region
			this._region = new Backbone.Marionette.Region({el: options.el});
		},
		
		getBooking: function(){
			return this._booking;
		},
		
		getFlightCollection: function(){
			return this._mcFlightCollection;
		},
		
		getFlightSelected: function(){
			return this._booking.get('selectedFlight');
		},
		
		getHotelCollection: function(){
			return this._hotelCollection;
		},
		
		getHotelSelected: function(){
			return this._booking.get('selectedHotel');
		},
		
		getAirlines: function(){
			return this._airlineCollection;
		},
		
		
		/*
		 *
		 *
		 * !LOADING FUNCTIONS
		 *
		 *
		 *
		*/
		
		/**
		 * addLoadingRequest
		 *
		 * @param {function} - a dummy param to wrap the function call in
		 *
		 * Inits (if needed) and increments the to be loaded count
		 *
		*/
		addLoadingRequest: function(request){
			if(this._fetchRequestTotal === null){
				this._isReady = false;
				this._fetchRequestTotal = 0;
				this._fetchRequestComplete = 0;
			}
			this._fetchRequestTotal++;
		},
		
		/**
		 * loadingCallback
		 *
		 * A function to be used as a 'success' callback for any function in order to perform
		 * the loading logic
		 *
		*/
		loadingCallback: function(){
			this._fetchRequestComplete++;
			
			if(this._fetchRequestTotal &lt;= this._fetchRequestComplete){
				this._isReady = true;
				if(this._toCallWhenLoaded !== null){
					this._toCallWhenLoaded();
					this._toCallWhenLoaded = null;
				}
			}
		},
		
		/**
		 * loadingQueue
		 *
		 * @param {function} fx - A function to call when loaded
		 *
		*/
		loadingQueue: function(fx){
			if(this._isReady === false){
				this._toCallWhenLoaded = fx;
			}
			else{
				fx();
			}
		},
		
		
		/*
		 *
		 *
		 * SHOW / HIDE FUNCTIONS
		 *
		 *
		*/
		
		show: function(){
			this.loadingQueue(this.showInterface);
		},
		
		showInterface: function(){
			this._layout = new SearchUILayout({
				holidaySearch: this._booking.get('holidaySearch'),
				flightsLoading: this.isFlightsLoading(),
				accommodationLoading: this.isAccommodationLoading()
			});
			
			this._region.show(this._layout);
		},
		
		hide: function(){
			this._region.close();
		},
		
		
		/* ================================================ */
		
		/* CALLBACK FUNCTIONS */
		
		/* ================================================ */
		
		/**
			Callback function to initiate a search with full data
			
			@param {holidaySearch model} A holidaySearch object with the search data
		*/
		saveSearchData: function(holidaySearch){
			vent.trigger('search:trip:edit',holidaySearch);
		},
		
		/**
			Callback function to initiate a search with a destination

			@param {string} The destination to search for
		*/
		saveSearchDestination: function(destination){
			this._booking.get('holidaySearch').set({'destination':destination.replace('-',' ')});
			vent.trigger('search:trip:edit',this._booking.get('holidaySearch'));
		},
		
		
		/**
			Callback function for when the search is edited
			
			@param {HolidaySearch Model} holidaySearch
		*/
		saveSearchEdit: function(holidaySearch){
			this._booking.getSearch().set(holidaySearch.toJSON());
			this.performSearch();
		},
		
		

		/*
		 *
		 * CALLBACKS
		 *
		 *
		*/
		
		/**
			@param {MulticomFlight Model} flight
		*/
		handleFlightSelection: function(flight){
			
			if(this._booking.get('selectedFlight') === null){
				this._booking.set({selectedFlight: new MulticomFlight()});
			}
			this._booking.get('selectedFlight').set(flight.toJSON());
		},
		
		/**
			@param {SymphonyHotel Model} hotel
		*/
		handleHotelSelection: function(hotel){
		
			if(this._booking.get('selectedHotel') === null){
				this._booking.set({selectedHotel: new SymphonyHotel()});
			}
			this._booking.get('selectedHotel').set(hotel.toJSON());
		},
		
		
		/*
		 *
		 * JSON SEARCHING FUNCTIONS
		 *
		 *
		*/
		
		/**
			performSearch
		*/
		performSearch: function(){
			var holSearch= this._booking.getSearch();
			this._mcAccommCollection.searchWithHolidaySearch(holSearch);
			this._mcFlightCollection.performSearch(holSearch.getFlightTrip());
			this._hotelCollection.fetchDestination(holSearch.get('destination'));
		},
		
		/**
		 * @returns {Boolean}
		*/
		isAccommodationLoading: function(){
			return this._mcAccommCollection.isLoading() || this._hotelCollection.isLoading();
		},
		
		/**
			isFlightsLoading
			@returns {Boolean}
		*/
		isFlightsLoading: function(){
			return this._mcFlightCollection.isLoading();
		},
		
		
		/**
			Callback to process hotel search results
		*/
		processHotelSearchResults: function(){
			if(!this._mcAccommCollection.isLoading() && !this._hotelCollection.isLoading()){
				
				this._hotelCollection.combineWithMulticomData(this._mcAccommCollection);
				vent.trigger('search:hotel:loaded', this._hotelCollection);
				
				/*
				 * A small amount of logic to trigger a package loading event
				 *
				 * Useful for views that want to know when everything is loaded
				 *
				 * See Also: processFlightSearchResults
				*/
				if(!this._mcFlightCollection.isLoading()){
					vent.trigger('search:package:loaded');
				}
			}
		},
		
		
		/**
			Callback to process flight results
		*/
		processFlightSearchResults: function(){
			vent.trigger('search:flight:selected', this._mcFlightCollection.at(0));
			vent.trigger('search:flight:loaded', this._mcFlightCollection);
			
			/*
			 * A small amount of logic to trigger a package loading event
			 *
			 * Useful for views that want to know when everything is loaded
			 *
			 * See Also: processHotelSearchResults
			*/

			if(!this._mcAccommCollection.isLoading() && !this._hotelCollection.isLoading()){
				vent.trigger('search:package:loaded');
			}
		},
		
		
		/**
			Event Callback for when a shortlist is requested
		*/
		onShortlistRequest: function(){
			//dummy code for now
			setTimeout(function(){
				vent.trigger('search:shortlist:complete');
			},800);
		}
		
	});
	
	return SearchUIController;
});
	</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="840a679355.html">Collection: MulticomAccommodationCollection</a></li><li><a href="901c05ffc7.html">Collection: MulticomFlightCollection</a></li><li><a href="7d3bc1a16e.html">Collection: MulticomRoomCollection</a></li><li><a href="e6589d1562.html">Collection: SymphonyAirlineCollection</a></li><li><a href="9c62b508f6.html">Collection: SymphonyHotelCollection</a></li><li><a href="563df19da6.html">Collection: TravellersInfo</a></li><li><a href="283ad868a2.html">ItemView: SearchUIHotelDetailSummaryView</a></li><li><a href="ba2575d9e6.html">Model: Booking</a></li><li><a href="03653e765f.html">Model: HolidaySearch</a></li><li><a href="a998eeaa5f.html">Model: TravellersInfo</a></li><li><a href="module-App.html">App</a></li></ul><h3>Classes</h3><ul><li><a href="7919174809.html">initialize</a></li><li><a href="SearchUIController.html">SearchUIController</a></li><li><a href="SearchUILayout.html">SearchUILayout</a></li><li><a href="TravellersContactView.html">TravellersContactView</a></li><li><a href="TravellersEditCollectionView.html">TravellersEditCollectionView</a></li><li><a href="TravellersEditItemView.html">TravellersEditItemView</a></li><li><a href="TravellersEditLayout.html">TravellersEditLayout</a></li><li><a href="TravellersLayout.html">TravellersLayout</a></li><li><a href="TravellersSummaryView.html">TravellersSummaryView</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_isReverseRelation">_isReverseRelation</a></li><li><a href="global.html#_prepareCollection">_prepareCollection</a></li><li><a href="global.html#addReverseRelation">addReverseRelation</a></li><li><a href="global.html#addSubModels">addSubModels</a></li><li><a href="global.html#build">build</a></li><li><a href="global.html#buildFromMulticomHotel">buildFromMulticomHotel</a></li><li><a href="global.html#checkPreconditions">checkPreconditions</a></li><li><a href="global.html#fetchRelated">fetchRelated</a></li><li><a href="global.html#find">find</a></li><li><a href="global.html#findOrCreate">findOrCreate</a></li><li><a href="global.html#getActivitiesByCategory">getActivitiesByCategory</a></li><li><a href="global.html#getActivityCategories">getActivityCategories</a></li><li><a href="global.html#getCollection">getCollection</a></li><li><a href="global.html#getObjectByName">getObjectByName</a></li><li><a href="global.html#getPagination">getPagination</a></li><li><a href="global.html#getProperty">getProperty</a></li><li><a href="global.html#getRelation">getRelation</a></li><li><a href="global.html#getRelations">getRelations</a></li><li><a href="global.html#getReverseRelations">getReverseRelations</a></li><li><a href="global.html#handleAddition">handleAddition</a></li><li><a href="global.html#handleClick">handleClick</a></li><li><a href="global.html#handleFlightsEdit">handleFlightsEdit</a></li><li><a href="global.html#handleFlightsPagination">handleFlightsPagination</a></li><li><a href="global.html#handleRemoval">handleRemoval</a></li><li><a href="global.html#handleSelectedEvent">handleSelectedEvent</a></li><li><a href="global.html#initialize">initialize</a></li><li><a href="global.html#initializeRelations">initializeRelations</a></li><li><a href="global.html#isDepartureTimeFiltered">isDepartureTimeFiltered</a></li><li><a href="global.html#onChange">onChange</a></li><li><a href="global.html#onRender">onRender</a></li><li><a href="global.html#onShow">onShow</a></li><li><a href="global.html#pageLeft">pageLeft</a></li><li><a href="global.html#pagePosition">pagePosition</a></li><li><a href="global.html#pageRight">pageRight</a></li><li><a href="global.html#parse">parse</a></li><li><a href="global.html#processQueue">processQueue</a></li><li><a href="global.html#queue">queue</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#resize">resize</a></li><li><a href="global.html#resolveIdForItem">resolveIdForItem</a></li><li><a href="global.html#retroFitRelation">retroFitRelation</a></li><li><a href="global.html#sanitizeOptions">sanitizeOptions</a></li><li><a href="global.html#saveRoomOccupancy">saveRoomOccupancy</a></li><li><a href="global.html#setCollection">setCollection</a></li><li><a href="global.html#setFromSymphony">setFromSymphony</a></li><li><a href="global.html#setMulticomData">setMulticomData</a></li><li><a href="global.html#setProperty">setProperty</a></li><li><a href="global.html#setRelated">setRelated</a></li><li><a href="global.html#setStatus">setStatus</a></li><li><a href="global.html#setTripType">setTripType</a></li><li><a href="global.html#setupSuperModel">setupSuperModel</a></li><li><a href="global.html#toggleFlightsColumn">toggleFlightsColumn</a></li><li><a href="global.html#toJSON">toJSON</a></li><li><a href="global.html#toJSONExpanded">toJSONExpanded</a></li><li><a href="global.html#trigger">trigger</a></li><li><a href="global.html#tryAddRelated">tryAddRelated</a></li><li><a href="global.html#unregister">unregister</a></li><li><a href="global.html#unsanitizeOptions">unsanitizeOptions</a></li><li><a href="global.html#update">update</a></li><li><a href="global.html#updateRelations">updateRelations</a></li><li><a href="global.html#updateRooms">updateRooms</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.1.0</a> on Tue Feb 26 2013 22:22:40 GMT-0000 (GMT)
</footer>

<script> prettyPrint(); </script>
</body>
</html>
